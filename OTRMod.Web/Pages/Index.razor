@page "/"
@using BlazorDownloadFile
@using OTRMod.ROM
@using OTRMod.OTR
@using OTRMod.Utility
@using OTRMod.Web.Services

<PageTitle>@T["get_mod_title"]</PageTitle>
<h1>@T["get_mod_h1"]</h1>
<br />
<p>
	<div class="mb-3">
		<label for="scriptFile" class="form-label">@T["sel_script"]</label>
		<InputFile class="form-control" type="file" id="scriptFile" OnChange="@ProcessScript" accept=".txt" single />
	</div>
</p>
<p>
	<div class="mb-3">
		<label for="romFile" class="form-label">@T["sel_rom"]</label>
		<InputFile class="form-control" type="file" id="romFile" OnChange="@ProcessROM" accept=".z64,.n64,.v64,.u64,.rom" single />
	</div>
</p>
<p>
	<div class="mb-3">
		<label for="outputFormat" class="form-label">@T["sel_format"]</label>
		<select class="form-select" id="outputFormat" @onchange="OnFormatChanged">
			<option value="O2R" selected="@(_outputFormat == OutputFormat.O2R)">O2R (.o2r)</option>
			<option value="OTR" selected="@(_outputFormat == OutputFormat.OTR)">OTR (.otr)</option>
		</select>
	</div>
</p>
@{
	var alertClass = StatusDisplay.GetAlertClass(GenState.State.Status);
	var msgKey = StatusDisplay.GetMessageKey(GenState.State.Status);
	var msgParams = StatusDisplay.GetMessageParams(GenState.State);
	var statusMsg = msgParams != null ? T[msgKey, msgParams] : T[msgKey];
}
<div class="alert @alertClass" role="alert">@statusMsg</div>
<button class="btn btn-primary" type="submit" disabled="@(!GenState.State.CanGenerate || GenState.State.IsWorking)" @onclick="GenerateMod">
	@if (GenState.State.Status == GenerationStatus.Generating) {
	<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>
	@($"\n{T["btn_wait"]}\n")
} else {
	@T["btn_gen_mod"]
}
</button>
@code {
[Inject] private IBlazorDownloadFileService DlFileService { get; set; } = null!;
[Inject] private SettingsService SettingsService { get; set; } = null!;
[Inject] private IGenerationStateManager GenState { get; set; } = null!;
[Inject] private IGenerationStatusDisplay StatusDisplay { get; set; } = null!;

private string[]? _script;
private readonly MemoryStream _scriptMs = new();
private readonly MemoryStream _romMs = new(); private MemoryStream _modMs = new();
private OutputFormat _outputFormat = OutputFormat.O2R;
private bool _scriptLoaded = false;
private bool _romLoaded = false;

protected override async Task OnInitializedAsync() {
	_outputFormat = await SettingsService.GetOutputFormatAsync();
	GenState.OnStateChanged += StateHasChanged;
}

private async void OnFormatChanged(ChangeEventArgs e) {
	if (Enum.TryParse<OutputFormat>(e.Value?.ToString(), out var format)) {
		_outputFormat = format;
		await SettingsService.SetOutputFormatAsync(format);
	}
}

private void UpdateGenStatus() {
	if (_scriptLoaded && _romLoaded)
		GenState.SetReady();
	else
		GenState.SetIdle();
}

private async Task ProcessScript(InputFileChangeEventArgs e) {
	_scriptLoaded = false;
	GenState.SetLoading("script");

	_scriptMs.SetLength(0);
	IBrowserFile scriptFile = e.File;
	if (_script != null) Array.Clear(_script, 0, _script.Length);
	await scriptFile.OpenReadStream().CopyToAsync(_scriptMs);

	_scriptLoaded = true;
	UpdateGenStatus();
}

private async Task ProcessROM(InputFileChangeEventArgs e) {
	_romLoaded = false;
	GenState.SetLoading("rom");

	_romMs.SetLength(0);
	IBrowserFile romFile = e.File;
	await romFile.OpenReadStream(ID.Size.ADec).CopyToAsync(_romMs);

	_romLoaded = true;
	UpdateGenStatus();
}

private async Task GenerateMod() {
	if (!_scriptLoaded || !_romLoaded) return;
	GenState.SetGenerating();
	await Task.Delay(10);
	try {
		await RunProcess();
		GenState.SetCompleted();
	} catch (Exception ex) {
		GenState.SetError(ex);
	}
}

private async Task RunProcess() {
	_script = _scriptMs.ToArray().ToStringArray();
	byte[] decompressed = Decompressor.Data(_romMs.ToArray().ToBigEndian(), calc: false);
	ScriptParser sParser = new() {
		ScriptStrings = _script,
		ImageData = decompressed,
	};
	sParser.ParseScript();
	_modMs.SetLength(0);

	string fileName;
	if (_outputFormat == OutputFormat.O2R) {
		Generate.FromImageO2R(ref _modMs);
		fileName = Path.ChangeExtension(sParser.OTRFileName, ".o2r");
	} else {
		Generate.FromImage(ref _modMs);
		fileName = sParser.OTRFileName;
	}

	await DlFileService.DownloadFile(fileName, _modMs, "application/octet-stream");
}
}